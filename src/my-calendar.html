<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../custom_elements/my-date-picker/my-date-picker.html">


<dom-module id="my-calendar">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      paper-date-picker{
        --paper-date-picker-heading:{
          display:none!important;
        }
       }
          :host .card {
            text-align: center;
        }
        
        paper-button.indigo {
            background-color: var(--paper-indigo-500);
            color: white;
            --paper-button-raised-keyboard-focus: {
              background-color: var(--paper-pink-a200) !important;
              color: white !important;
            };
        }

        paper-button.green {
            background-color: var(--paper-green-500);
            color: white;   
        }
        paper-button.green[active] {
            background-color: var(--paper-red-500);
        }
      }
    </style>
      <firebase-document id="fbDocument"
      location='https://events-list.firebaseio.com/events'
      data="{{events}}"></firebase-document>
      
    <iron-media-query query="(min-width: 1390px)" query-matches="{{showSmallCalendar}}"></iron-media-query>
    <div style="margin:auto">
        <paper-item id="smallCalendar" hidden$={{showSmallCalendar}}>
          <span>[[date]]</span>
        </paper-item>

        <div style="float: left; width: 40%;" hidden$={{!showSmalllCalendar}}>
          <my-date-picker id="datepicker" force-narrow date={{date}} week-mode={{_weekMode}}></my-date-picker>
        </div>

        <div style="float: right; width: 60%;">
            <div class="card">
                <paper-button raised toggles class="custom indigo" on-tap="filterDaily">Daily</paper-button>
                <paper-button raised toggles class="custom green" on-tap="filterWeekly">Weekly</paper-button>
            </div>
            <template is="dom-repeat" items="[[appData]]" as="event" id="table_template">
                <div class="card">
                  <div class="circle">[[event.id]]</div>
                      <h1>[[event.name]]</h1>
                      <h1>From : [[event.fromDate]] [[event.fromHour]] to [[event.endDate]] [[event.endHour]]</h1>
                      <p>[[event.description]]</p>
                </div>
            </template>
        </div>
    </div>
      
      
    
        
      
  </template>

  <script>
    Polymer({
      is: 'my-calendar',

      properties:{
        _weekMode:Boolean
      },

        
      ready:function(){
       this.$.datepicker.style.color = "red";
      },
         filterDaily: function() {
        
          this.appData = this.shadowArray;
          var today = (new Date()).getDate();
          this.appData  = this.appData.filter(function(o){
              var fromDate = new Date(o.fromDate);
              var endDate = new Date(o.endDate);
              var isIncluded = today === fromDate.getDate() || today === endDate.getDate();
              return isIncluded;
          } );
          //this.appData = [{id:"1", name:"alfa", date:"2017-02-10", description:"test desc"}];
      },
        filterByDay: function(value) {
        
          this.appData = this.shadowArray;
          var today = value.getDate();
          this.appData  = this.appData.filter(function(o){
              var fromDate = new Date(o.fromDate);
              var endDate = new Date(o.endDate);
              var isIncluded = today === fromDate.getDate() || today === endDate.getDate();
              return isIncluded;
          } );
          //this.appData = [{id:"1", name:"alfa", date:"2017-02-10", description:"test desc"}];
      },
    filterWeekly: function() {
        this._weekMode = true;
         var weekNumber = this.getWeekNumber();
          this.events  = this.events.filter(function(o){return o.week == weekNumber.toString();} );
          //this.appData = [{id:"1", name:"alfa", date:"2017-02-10", description:"test desc"}];
      },
    getWeekNumber: function(exact) {
            var now = new Date();
            var month = now.getMonth()
                , year = now.getFullYear()
                , firstWeekday = new Date(year, month, 1).getDay()
                , lastDateOfMonth = new Date(year, month + 1, 0).getDate()
                , offsetDate = now.getDate() + firstWeekday - 1
                , index = 1 // start index at 0 or 1, your choice
                , weeksInMonth = index + Math.ceil((lastDateOfMonth + firstWeekday - 7) / 7)
                , week = index + Math.floor(offsetDate / 7)
            ;
            if (exact || week < 2 + index) return week;
            return week === weeksInMonth ? index + 5 : week;
        },
        properties: {
          firebaseURL:{
                      type: String,
                      value: 'https://events-list.firebaseio.com/events'
                  },
          firebaseProvider:{
                      type: String,
                      value: 'anonymous'
                  },
          appData: {
            type: Array,
            notify:true,
            observer: "_dataBound"
          },
          shadowData :{
              type:Array,
              notify:true
          },
          filterDate: {
            type:Date,
            notify:true
          }
      },
      attached: function(){
            
            var host = this;

            //Listens to the child's sharedValue. When changed it will update host's sharedValue.
            this.$.fbDocument.addEventListener("data-changed", function(e){
                
                host.appData = e.detail.value;
                host.shadowArray = e.detail.value;
            });
          
          this.$.datepicker.addEventListener("date-changed", function(e){
                host.filterDate = e.detail.value;
                host.filterByDay(host.filterDate);
              console.log('date changed to ' + host.filterDate);
            });
            
        },
        _dataBound:function(e){
           //this.shadowArray = JSON.parse(JSON.stringify(this.appData));
        }
    });
  </script>
</dom-module>
